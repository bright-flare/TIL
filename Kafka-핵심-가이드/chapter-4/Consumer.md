


# Consumer ? 

카프카에서 데이터를 읽는 Application은 토픽을 구독하고, 구독한 토픽들로부터 메세지를 받기위해 KafkaConsumer를 사용한다.
- 컨슈머는 메세지를 읽는다. 다른 발행/구독 시스템에서는 subscriber 또는 reader라고도 한다.
- 컨슈머는 1개 이상의 토픽을 구독해서 저장된 메세지들을 각 파티션에 쓰여진 `순서대로` 읽어온다.
- 컨슈머는 offset을 통해 읽기 작업을 정지했다가 다시 시작하더라도 마지막으로 읽었던 메세지의 바로 다음 메세지부터 읽을 수 있다. 


# Offset ?

- offset은 카프카가 메세지를 저장할 떄 각각의 메세지에 부여해주는 meta data 이다.
- 파티션의 각 메세지는 고유한 offset을 가진다.
- 지속적으로 증가하는 정수값이다.
- 뒤에 오는 메세지일수록 offset이 크다.

# Consumer Group ?

- 일반적으로 컨슈머는 컨슈머 그룹의 일원으로서 작동한다.
- 컨슈머 그룹은 토픽에 저장된 데이터를 읽어오기 위해 협업하는 하나 이상의 컨슈머로 이루어진다.
- 컨슈머에서 파티션으로의 대응 관계는 컨슈머의 파티션 소유권(ownership)이라고도 부른다.
- 컨슈머 그룹에 속한 컨슈머 중 하나에 장애가 발생하더라도 그룹 안의 다른 컨슈머들이 장애가 발생한 컨슈머가 읽고 있던 파티션을 재할당 받은 뒤 이어서 데이터를 읽을 수 있다.


# Consumer 를 왜 Group으로 사용하는가

## 시나리오

카프카로부터 구독한 토픽을 읽어들여 연산처리와 DB 저장을 수행하는 Application이 있다고 가정할 경우.
만약 프로듀서가 Application이 처리하는 연산속도보다 더 빠른 속도로 토픽에 메세지를 Write한다면 어떻게 될까 ? 
Consumer가 그림과 같이 하나뿐이라면 Application은 새로 추가되는 메세지의 속도를 따라잡을 수 없기 때문에 메세지 처리가 계속 지연된다.

![[2. 개인/3. study/TIL/Kafka-핵심-가이드/images/컨슈머그룹1.png]]

💡 여러개의 프로듀서가 동일한 토픽에 메세지를 쓰듯이 여러개의 컨슈머가 같은 토픽으로부터 메세지를 분할해서 읽어오게 한다면 메세지 처리량을 증가 시킬 수 있다.


A라는 토픽에 3개 파티션의 데이터를 담당하는 컨슈머 그룹이 있다.
![[컨슈머 C1.png]]

# 컨슈머 확장
컨슈머 그룹 C1에 컨슈머를 추가함으로써 데이터를 읽어오는 작업을 확장할 수 있다.
A토픽에 3개 파티션의 데이터를 3개의 컨슈머가 분할해서 읽기때문에 처리량이 증가한다.
![[컨슈머 그룹 C1-2.png]]


## 🔴 컨슈머 확장시 주의

- 토픽에 설정된 파티션 수 이상으로 컨슈머를 투입하는 것은 아무의미 없다는 점을 명심해야 한다 !!
	- 몇몇 컨슈머는 그냥 놀게될 수 있다.
- 처음에 토픽을 생성할 때 파티션 수를 크게 잡아놓는다면, 부하가 증가함에 따라서 더 많은 컨슈머를 추가할 수 있다.
	- 토픽의 파티션 개수를 선정하는 방법은 다음에..
![[컨슈머 그룹 C1-3.png]]

# Application 규모 확장

단순히 컨슈머 수를 늘려 처리량을 확장하는 경우와는 달리, A라는 토픽의 데이터를 여러 용도로 활용하는 Application이 생겨날 수 있다.

각각의 Application이 각자의 컨슈머 그룹을 갖으면 동일한 토픽 데이터를 활용할 수 있다.

![[컨슈머 그룹 C1-4.png]]

## 컨슈머 그룹에 따른 성능저하 ? 🤔

막연하게 생각했을 때, 컨슈머 그룹이 많으면 성능이 저하되지 않을까 생각이 든다.
그런데 카프카는 성능 저하 없이 많은 수의 컨슈머와 컨슈머 그룹으로 확장이 가능하다고 한다.

다른 전통적인 메세지 큐 시스템은 구독 시스템으로 메세지를 push 한다.
- 이렇게되면 메세지큐 시스템은 구독시스템의 처리 성능을 염두하며 push 해야한다.

카프카 브로커는 컨슈머로 데이터를 push하지 않는다.
- 컨슈머가 자신이 기록해 두었던 offset부터 데이터를 요청하여 전달받는다.
- 브로커는 컨슈머가 요청한 만큼의 데이터만 전달해주면 되기때문에 Client app의 처리성능을 고려하지않아도 된다.
