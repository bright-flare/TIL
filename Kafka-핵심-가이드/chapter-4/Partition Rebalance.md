

# Partition Rebalance ?

여러가지 이유에 의해서 컨슈머에 할당된 파티션을 다른 컨슈머에게 할당해주는 작업을 파티션 리밸런스라고 한다.

## 리밸런스가 발생하는 경우

- 새로운 컨슈머가 컨슈머 그룹에 추가되었을 때
- 컨슈머가 종료되거나 Crash났을 경우, 컨슈머가 죽었다고 판단되는 경우
	- 컨슈머가 컨슈머 그룹에서 나가면 원래 컨슈머가 읽던 파티션들은 그룹에 잔류한 나머지 컨슈머 중 하나가 대신 받아서 읽기 시작한다.
- 컨슈머 그룹이 읽고 있는 토픽 새로운 파티션이 추가된 경우.
- 시간안에 poll 요청이 실패하는 경우. (timeout 설정값에 의해)

# 리밸런스 전략

리밸런스에는 컨슈머 그룹이 사용하는 파티션 할당 전략에 따라 2가지가 있다.


## 1️⃣ Eager rebalance (조급한 리밸런스)

- 조급한 리밸런스 실행시 모든 컨슈머는 읽기 작업을 멈추고 자신에게 할당된 모든 파티션에 대한 소유권을 포기한 뒤, 컨슈머 그룹에 다시 참여하여 새로운 파티션을 할당받는다.
- Stop the world.
	- JVM GC 진행시 모든 스레드가 멈추는 것처럼 모든 컨슈머는 일시적으로 작업을 멈춘다.
- 파티션을 포기한 컨슈머 모두가 다시 그룹에 참여한 뒤에 새로운 파티션을 할당받고 읽기 작업을 재개할 수 있다.

### 진행 순서
1. 모든 파티션 할당 해제
2. 읽기 작업 정지
3. 파티션 재할당


## 2️⃣ Cooperative rebalance (협력적 or 점진적 리밸런스)

- 한 컨슈머에게 할당되어 있던 파티션만을 다른 컨슈머에게 재할당한다.
- Stop the world 발생하지 않는다.
- 리밸런싱 작업에 상당한 시간이 걸릴 위험이 있는 컨슈머 그룹에 속한 컨슈머 수가 많은 경우에 중요하다.
	- 전체 작업 정지가 일어나지 않으니까.

### 간단 진행 순서
1. 컨슈머 그룹 리더가 다른 컨슈머들에게 각자에게 할당된 파티션 중 일부가 재할당될 것이라고 통보하면, 컨슈머들은 해당 파티션에서 데이터를 읽어오는 작업을 멈추고 해당 파티션에 대한 소유권을 포기한다.
2. 컨슈머 그룹 리더가 포기된 파티션들을 새로 할당한다.
	1. 안정적으로 파티션이 할당될 때까지 몇번이고 반복될 수 있다.


# Group Coordinator
[[Group Coordinator ?]]

# Heartbeat
[[Heartbeat ?]]

## Consumer, Coordinator와 심장박동수

컨슈머는 해당 컨슈머 그룹의 그룹 코디네이터 역할을 지정받은 카프카 브로커에 heartbeat를 전송함으로써 멤버쉽과 할당된 파티션에 대한 소유권을 유지한다.

1️⃣ 컨슈머가 일정 시간이상 하트비트를 전송하지 않는다면 session timeout이 발생하면서 그룹 코디네이터는 해당 컨슈머가 죽었다고 간주하고 리밸런스를 실행한다.
컨슈머가 crash 났을경우, 메세지 처리를 중단했을 경우, 그룹 코디네이터는 하트비트가 들어오지 않는 것을 보고 컨슈머가 죽었다고 판단한 뒤 리밸런스를 실행한다.
이 몇 초 동안 죽은 컨슈머에 할당되어 있던 파티션에서는 아무 메세지도 처리되지 않는다.

2️⃣ 컨슈머를 깔끔하게 닫아줄 경우 컨슈머는 그룹 코디네이터에게 그룹을 나간다고 통보하는데, 이 경우 즉시 리밸런스를 실행함으로써 처리가 메세지 처리가 정지되는 시간을 줄인다.


# 파티션은 어떻게 컨슈머에게 할당 되는가 ?

- 컨슈머가 그룹에 참여하고 싶을 때는 그룹 코디네이터에게 JoinGorup 요청을 보낸다.
- 가장 먼저 참여한 컨슈머가 그룹의 리더가 된다.
- 리더는 그룹 코디네이터로부터 해당 그룹 안에 있는 모든 컨슈머의 목록을 받아서 각 컨슈머에게 파티션을 할당한다.
	- PartitionAssignor 인터페이스를 구현하면 어느 파티션이 어느 컨슈머에 할당되어야 하는지 결정할 수 있다.
- 파티션 할당이 결정되면 컨슈머 그룹 리더는 할당 내역을 GroupCoordinator에게 전달하고 그룹 코디네이터는 다시 이정보를 모든 컨슈머에게 전파한다.
- 리더가 아닌 컨슈머들은 자기에게 할당된 내역만 알 수 있다.
- 리더만 유일하게 컨슈머 그룹내 컨슈머와 파티션 할당 내역 전부를 볼 수 있다.
- 이 과정은 리밸런스가 발생할 때마다 반복적으로 수행된다.


# 참고 💡

kafka 2.4 version 이후로 Eager rebalance가 default 전략 이었지만, 3.1 부터는 Cooperative rebalance가 기본 전략이 되었다. 조급한 리밸런스는 Deprecated될 예정.
내부적으로  카프카 컨슈머를 사용하는 카프카 스트림즈 라이브러도 적용되는 내용이다.